name: "ğŸ”„ README Stats Sync"

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/main/java/boj/**"
      - ".github/workflows/readme-sync.yml"
      - "docs/problems/**"
      - "mkdocs.yml"
  workflow_dispatch: {}

permissions:
  contents: write

# ê°™ì€ ë¸Œëœì¹˜ì—ì„œ ë™ì‹œì— ëŒë©´ ê²½í•© â†’ ì·¨ì†Œ/ë‹¨ì¼í™”
concurrency:
  group: readme-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate problem table & update mkdocs nav
        id: gen
        run: |
          python - <<'PY'
          import glob, re, pathlib, io, os

          # ë¬¸ì œ ë²ˆí˜¸ ìˆ˜ì§‘
          nums = []
          for p in glob.glob("src/main/java/boj/p[0-9]*"):
            m = re.search(r"p(\d+)$", p)
            if m: nums.append(int(m.group(1)))
          nums = sorted(set(nums))

          # README í‘œ ìƒì„± (ë¬¸ì„œ ë§í¬ëŠ” ì¡´ì¬í•  ë•Œë§Œ)
          rows = ["| ë²ˆí˜¸ | ë§í¬ | ë©”ëª¨ |", "|---:|:---|:---|"]
          for n in nums:
            pad = f"{n:05d}"
            code = f"src/main/java/boj/p{n}/Main.java"
            doc_md = pathlib.Path(f"docs/problems/{pad}.md")
            links = []
            if doc_md.exists():
              links.append(f"[ë¬¸ì„œ](https://v4n1lla.github.io/boj-java/problems/{pad}/)")
            links.append(f"[ì½”ë“œ]({code})")
            rows.append(f"| {pad} | {' / '.join(links)} |  |")
          table = "\n".join(rows) + "\n"
          pathlib.Path("problem_table.md").write_text(table, encoding="utf-8")

          # mkdocs.yml NAV ìë™ ì¹˜í™˜ (PROBLEM_NAV ë¸”ë¡ë§Œ)
          mk_path = pathlib.Path("mkdocs.yml")
          mk = mk_path.read_text(encoding="utf-8")
          start = "# PROBLEM_NAV:START"
          end   = "# PROBLEM_NAV:END"
          pat = re.compile(rf"({re.escape(start)})(.*?)({re.escape(end)})", re.S)

          nav_lines = []
          for n in nums:
            pad = f"{n:05d}"
            if pathlib.Path(f"docs/problems/{pad}.md").exists():
              nav_lines.append(f"      - BOJ {pad}: problems/{pad}.md")
          if not nav_lines:
            nav_lines = ["      # (ë¬¸ì„œ ìŠ¤í…ì´ ì—†ìŠµë‹ˆë‹¤)"]

          if pat.search(mk):
            block = "\n".join([start] + nav_lines + [end])
            mk2 = pat.sub(block, mk)
            if mk2 != mk:
              mk_path.write_text(mk2, encoding="utf-8")
              print("NAV_UPDATED")

          # GITHUB_OUTPUTë¡œ í‘œ ê²½ë¡œ ì „ë‹¬
          with open(os.environ["GITHUB_OUTPUT"], "a") as gh:
            gh.write(f"table_path=problem_table.md\n")
          PY

      - name: Update README (marker replace)
        id: upd
        run: |
          RESULT=$(python3 scripts/update_readme.py < "${{ steps.gen.outputs.table_path }}")
          echo "result=$RESULT" >> "$GITHUB_OUTPUT"
          echo "update_readme.py said: $RESULT"

      - name: Commit & push if changed (rebase + stash + retry)
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          # ë³€ê²½ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes."; exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin "$REF_NAME"

          # ì‘ì—…íŠ¸ë¦¬ ë³€ê²½ ì ì‹œ ë³´ê´€ (rebase ëŒ€ë¹„)
          git stash push -u -m "ci-readme-sync-autostash" || true

          # ìµœì‹ ìœ¼ë¡œ ë§ì¶”ê¸°
          git rebase "origin/$REF_NAME" || { git rebase --abort || true; }

          # ë³€ê²½ ë³µì›(ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ í†µê³¼)
          git stash pop || true

          # íƒ€ê¹ƒ íŒŒì¼ë§Œ ìŠ¤í…Œì´ì§•
          git add README.md mkdocs.yml problem_table.md || true

          # ìŠ¤í…Œì´ì§• ì—†ìœ¼ë©´ ì¢…ë£Œ
          if git diff --cached --quiet; then
            echo "No staged changes for target files."; exit 0
          fi

          # í‘¸ì‹œ ì¬ì‹œë„(ê²½í•© ëŒ€ë¹„ 3íšŒ)
          for i in 1 2 3; do
            if git push origin "HEAD:$REF_NAME"; then
              echo "Pushed."; exit 0
            fi
            echo "Push failed (#$i). Rebasing and retrying..."
            git fetch origin "$REF_NAME"
            git stash push -u -m "ci-readme-sync-retry-$i" || true
            git rebase "origin/$REF_NAME" || { git rebase --abort || true; }
            git stash pop || true
            sleep 2
          done

          echo "âŒ Push still failing after retries."
          exit 1